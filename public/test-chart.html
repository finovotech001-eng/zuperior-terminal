<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TradingView Chart Test</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      background: #01040D;
      color: #fff;
      font-family: system-ui, -apple-system, sans-serif;
    }
    #chart_container {
      width: 100%;
      height: 600px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
    }
    .info {
      margin: 20px 0;
      padding: 10px;
      background: rgba(139, 92, 246, 0.1);
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>TradingView Chart Test</h1>
  <div class="info">
    <p>Testing TradingView integration with MT5 data</p>
    <p>Symbol: <strong>XAUUSD</strong></p>
  </div>
  
  <div id="chart_container"></div>

  <script src="/charting_library/charting_library.standalone.js"></script>
  <script>
    // Create a simple datafeed
    class SimpleDatafeed {
      onReady(callback) {
        setTimeout(() => {
          callback({
            supported_resolutions: ['1', '5', '15', '30', '60', '240', 'D'],
            supports_group_request: false,
            supports_marks: false,
            supports_search: true,
            supports_time: true,
            supports_timescale_marks: false,
          });
        }, 0);
      }

      resolveSymbol(symbolName, onResolved, onError) {
        setTimeout(() => {
          onResolved({
            name: symbolName,
            ticker: symbolName,
            description: symbolName,
            type: 'crypto',
            session: '24x7',
            timezone: 'Etc/UTC',
            exchange: 'FOREX',
            minmov: 1,
            pricescale: 100,
            has_intraday: true,
            supported_resolutions: ['1', '5', '15', '30', '60', '240', 'D'],
            volume_precision: 2,
            data_status: 'streaming',
            full_name: symbolName,
          });
        }, 0);
      }

      getBars(symbolInfo, resolution, periodParams, onResult, onError) {
        console.log('[Datafeed] Fetching bars for', symbolInfo.ticker, 'resolution', resolution);
        
        const url = `/apis/chart/proxy?symbol=${symbolInfo.ticker}&timeframe=${resolution}&count=300`;
        
        fetch(url)
          .then(response => response.json())
          .then(data => {
            console.log('[Datafeed] Received', data.length, 'bars');
            
            const bars = data.map(candle => ({
              time: new Date(candle.time).getTime(),
              low: candle.low,
              high: candle.high,
              open: candle.open,
              close: candle.close,
              volume: candle.volume,
            }));
            
            onResult(bars);
          })
          .catch(error => {
            console.error('[Datafeed] Error:', error);
            onError('Failed to fetch data');
          });
      }

      subscribeBars(symbolInfo, resolution, onTick, subscriberUID, onResetCache) {
        console.log('[Datafeed] Subscribing to updates');
        
        const interval = setInterval(() => {
          this.getBars(symbolInfo, resolution, null, (bars) => {
            if (bars && bars.length > 0) {
              onTick(bars);
            }
          }, (error) => {
            console.error('Subscription error:', error);
          });
        }, 2000);
        
        // Store interval for cleanup
        this.subscriptions = this.subscriptions || new Map();
        this.subscriptions.set(subscriberUID, interval);
      }

      unsubscribeBars(subscriberUID) {
        console.log('[Datafeed] Unsubscribing');
        if (this.subscriptions && this.subscriptions.has(subscriberUID)) {
          clearInterval(this.subscriptions.get(subscriberUID));
          this.subscriptions.delete(subscriberUID);
        }
      }
    }

    // Initialize the chart when library is ready
    window.addEventListener('DOMContentLoaded', () => {
      if (typeof TradingView === 'undefined') {
        console.error('TradingView library not loaded');
        return;
      }

      console.log('Initializing TradingView widget...');
      
      const widget = new TradingView.widget({
        debug: false,
        fullscreen: false,
        symbol: 'XAUUSD',
        interval: '1',
        container: 'chart_container',
        library_path: '/charting_library/',
        locale: 'en',
        theme: 'dark',
        datafeed: new SimpleDatafeed(),
        overrides: {
          'paneProperties.background': '#01040D',
          'paneProperties.backgroundType': 'solid',
          'paneProperties.vertGridProperties.color': 'rgba(139, 92, 246, 0.08)',
          'paneProperties.horzGridProperties.color': 'rgba(139, 92, 246, 0.08)',
          'mainSeriesProperties.candleStyle.upColor': '#3B82F6',
          'mainSeriesProperties.candleStyle.downColor': '#EF4444',
        },
        autosize: true,
      });

      widget.onChartReady(() => {
        console.log('Chart is ready!');
      });
    });
  </script>
</body>
</html>

